<html>

<head>
    <style>
        pre {
            background: #1e1e1e;
            padding: 15px;
            color: #dfdfdf;
            margin-bottom: 0;
        }

        .header {
            top: 0;
            width: 100%;
            height: 150px;
            color: black;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen-Sans", "Ubuntu", "Cantarell", "Helvetica Neue", sans-serif;
            padding-top: 20px;
            margin-left: 50px;
        }

        .header h1 {
            font-size: 60px;
            margin-bottom: 0px;
            margin-top: 0px;
        }

        .header h2 {
            font-size: 18px;
        }

        section {
            font-family: Georgia, "Times New Roman", serif;
            width: 700px;
            font-size: 18px;
            margin-left: 50px;
            line-height: 30px;
            margin-top: 25px;
            margin-bottom: 25px;
        }

        code {
            padding: 2px 5px;
            font-family: Monaco, Consolas, "Andale Mono", "DejaVu Sans Mono", monospace;
            background: #eee;
        }

        .comment {
            color: #688e49;
        }

        .for {
            color: #b680ba;
        }

        .in {
            color: #5b94cf;
        }

        .array {
            font: bold;
        }

        .array-bracket {
            font-family: sans-serif;
            font-size: 4em;
        }

        .array-name {
            font-family: sans-serif;
            font-size: 1.5em;
        }

        .active-line {
            background: #8e8f32;
            color: #ddd;
        }

        .controls-container {
            background: #1e1e1e;
            box-shadow: 0px 5px 7px black;
            width: 216px;
            height: 32px;
        }


        .controls-container button {
            background: transparent;
            border: none;
            width: 28px;
            height: 28px;
            float: left;
            background-repeat: no-repeat;
            background-position: center;
            padding: 0 20px;
        }

        .controls-container button:hover {
            cursor: pointer;
        }

        .controls-container .play {
            background-size: 20px;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNiAxNiI+PGRlZnM+PHN0eWxlPi5pY29uLWNhbnZhcy10cmFuc3BhcmVudCwuaWNvbi12cy1vdXR7ZmlsbDojZjZmNmY2O30uaWNvbi1jYW52YXMtdHJhbnNwYXJlbnR7b3BhY2l0eTowO30uaWNvbi12cy1hY3Rpb24tZ3JlZW57ZmlsbDojMzg4YTM0O308L3N0eWxlPjwvZGVmcz48dGl0bGU+Y29udGludWU8L3RpdGxlPjxnIGlkPSJjYW52YXMiPjxwYXRoIGNsYXNzPSJpY29uLWNhbnZhcy10cmFuc3BhcmVudCIgZD0iTTE2LDBWMTZIMFYwWiIvPjwvZz48ZyBpZD0ib3V0bGluZSIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7Ij48cGF0aCBjbGFzcz0iaWNvbi12cy1vdXQiIGQ9Ik0xNC4zMzQsOCwzLjY2NywxNkgzVjBoLjY2N1oiLz48L2c+PGcgaWQ9Imljb25CZyI+PHBhdGggY2xhc3M9Imljb24tdnMtYWN0aW9uLWdyZWVuIiBkPSJNNCwxLjV2MTNMMTIuNjY3LDgsNCwxLjVaIi8+PC9nPjwvc3ZnPg==');
        }

        .controls-container .back {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwKSI+CjxwYXRoIGQ9Ik02IDEzQzYgMTMuMzk1NiA2LjExNzMgMTMuNzgyMiA2LjMzNzA2IDE0LjExMTFDNi41NTY4MiAxNC40NCA2Ljg2OTE4IDE0LjY5NjQgNy4yMzQ2MyAxNC44NDc4QzcuNjAwMDggMTQuOTk5MSA4LjAwMjIyIDE1LjAzODcgOC4zOTAxOCAxNC45NjE2QzguNzc4MTQgMTQuODg0NCA5LjEzNDUxIDE0LjY5MzkgOS40MTQyMSAxNC40MTQyQzkuNjkzOTIgMTQuMTM0NSA5Ljg4NDQgMTMuNzc4MSA5Ljk2MTU3IDEzLjM5MDJDMTAuMDM4NyAxMy4wMDIyIDkuOTk5MTMgMTIuNjAwMSA5Ljg0Nzc2IDEyLjIzNDZDOS42OTYzOCAxMS44NjkyIDkuNDQwMDQgMTEuNTU2OCA5LjExMTE0IDExLjMzNzFDOC43ODIyNCAxMS4xMTczIDguMzk1NTYgMTEgOCAxMUM3LjQ2OTU3IDExIDYuOTYwODYgMTEuMjEwNyA2LjU4NTc5IDExLjU4NThDNi4yMTA3MSAxMS45NjA5IDYgMTIuNDY5NiA2IDEzWiIgZmlsbD0iIzQyNDI0MiIvPgo8cGF0aCBkPSJNMC45OTk5OTggMlY4SDdWNkg0Ljc2M0M1LjI3MzAzIDUuMjMzMjMgNi4wMDY5MyA0LjY0MjI0IDYuODY0ODEgNC4zMDc0MkM3LjcyMjY5IDMuOTcyNjEgOC42NjI5IDMuOTEwMjQgOS41NTc0OSA0LjEyODgxQzEwLjQ1MjEgNC4zNDczNyAxMS4yNTc2IDQuODM2MjYgMTEuODY0NCA1LjUyODkzQzEyLjQ3MTMgNi4yMjE2MSAxMi44NSA3LjA4NDQzIDEyLjk0OSA4SDE0Ljk3NUMxNC44NzMzIDYuNjM1MiAxNC4zNDIyIDUuMzM3NiAxMy40NTc5IDQuMjkzMTJDMTIuNTczNiAzLjI0ODYzIDExLjM4MTMgMi41MTA4NiAxMC4wNTIgMi4xODU0OUM4LjcyMjYyIDEuODYwMTIgNy4zMjQ0IDEuOTYzODUgNi4wNTc2MyAyLjQ4MTgzQzQuNzkwODUgMi45OTk4MSAzLjcyMDUzIDMuOTA1NDUgMyA1LjA2OVYySDAuOTk5OTk4WiIgZmlsbD0iIzAwNTM5QyIvPgo8L2c+CjxkZWZzPgo8Y2xpcFBhdGggaWQ9ImNsaXAwIj4KPHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSJ3aGl0ZSIgdHJhbnNmb3JtPSJtYXRyaXgoLTEgMCAwIDEgMTYgMCkiLz4KPC9jbGlwUGF0aD4KPC9kZWZzPgo8L3N2Zz4=');
            margin-left: 20px;
        }

        .controls-container .stop {
            background-size: 20px;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNiAxNiI+PGRlZnM+PHN0eWxlPi5pY29uLWNhbnZhcy10cmFuc3BhcmVudCwuaWNvbi12cy1vdXR7ZmlsbDojZjZmNmY2O30uaWNvbi1jYW52YXMtdHJhbnNwYXJlbnR7b3BhY2l0eTowO30uaWNvbi12cy1hY3Rpb24tcmVke2ZpbGw6I2ExMjYwZDt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPnN0b3A8L3RpdGxlPjxnIGlkPSJjYW52YXMiPjxwYXRoIGNsYXNzPSJpY29uLWNhbnZhcy10cmFuc3BhcmVudCIgZD0iTTE2LDBWMTZIMFYwWiIvPjwvZz48ZyBpZD0ib3V0bGluZSIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7Ij48cGF0aCBjbGFzcz0iaWNvbi12cy1vdXQiIGQ9Ik0xNCwyVjE0SDJWMloiLz48L2c+PGcgaWQ9Imljb25CZyI+PHBhdGggY2xhc3M9Imljb24tdnMtYWN0aW9uLXJlZCIgZD0iTTEzLDNWMTNIM1YzWiIvPjwvZz48L3N2Zz4=');
        }

        .controls-container .forward {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwKSI+CjxwYXRoIGQ9Ik02IDEzQzYgMTMuMzk1NiA2LjExNzMgMTMuNzgyMiA2LjMzNzA2IDE0LjExMTFDNi41NTY4MiAxNC40NCA2Ljg2OTE4IDE0LjY5NjQgNy4yMzQ2MyAxNC44NDc4QzcuNjAwMDggMTQuOTk5MSA4LjAwMjIyIDE1LjAzODcgOC4zOTAxOCAxNC45NjE2QzguNzc4MTQgMTQuODg0NCA5LjEzNDUxIDE0LjY5MzkgOS40MTQyMSAxNC40MTQyQzkuNjkzOTIgMTQuMTM0NSA5Ljg4NDQgMTMuNzc4MSA5Ljk2MTU3IDEzLjM5MDJDMTAuMDM4NyAxMy4wMDIyIDkuOTk5MTMgMTIuNjAwMSA5Ljg0Nzc2IDEyLjIzNDZDOS42OTYzOCAxMS44NjkyIDkuNDQwMDQgMTEuNTU2OCA5LjExMTE0IDExLjMzNzFDOC43ODIyNCAxMS4xMTczIDguMzk1NTYgMTEgOCAxMUM3LjQ2OTU3IDExIDYuOTYwODYgMTEuMjEwNyA2LjU4NTc5IDExLjU4NThDNi4yMTA3MSAxMS45NjA5IDYgMTIuNDY5NiA2IDEzWiIgZmlsbD0iIzQyNDI0MiIvPgo8cGF0aCBkPSJNMC45OTk5OTggMlY4SDdWNkg0Ljc2M0M1LjI3MzAzIDUuMjMzMjMgNi4wMDY5MyA0LjY0MjI0IDYuODY0ODEgNC4zMDc0MkM3LjcyMjY5IDMuOTcyNjEgOC42NjI5IDMuOTEwMjQgOS41NTc0OSA0LjEyODgxQzEwLjQ1MjEgNC4zNDczNyAxMS4yNTc2IDQuODM2MjYgMTEuODY0NCA1LjUyODkzQzEyLjQ3MTMgNi4yMjE2MSAxMi44NSA3LjA4NDQzIDEyLjk0OSA4SDE0Ljk3NUMxNC44NzMzIDYuNjM1MiAxNC4zNDIyIDUuMzM3NiAxMy40NTc5IDQuMjkzMTJDMTIuNTczNiAzLjI0ODYzIDExLjM4MTMgMi41MTA4NiAxMC4wNTIgMi4xODU0OUM4LjcyMjYyIDEuODYwMTIgNy4zMjQ0IDEuOTYzODUgNi4wNTc2MyAyLjQ4MTgzQzQuNzkwODUgMi45OTk4MSAzLjcyMDUzIDMuOTA1NDUgMyA1LjA2OVYySDAuOTk5OTk4WiIgZmlsbD0iIzAwNTM5QyIvPgo8L2c+CjxkZWZzPgo8Y2xpcFBhdGggaWQ9ImNsaXAwIj4KPHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSJ3aGl0ZSIgdHJhbnNmb3JtPSJtYXRyaXgoLTEgMCAwIDEgMTYgMCkiLz4KPC9jbGlwUGF0aD4KPC9kZWZzPgo8L3N2Zz4=');
            transform: scaleX(-1);
        }

        #myGlower {
            border: 1px solid transparent;
            -webkit-transition: border 0.1s linear, box-shadow 0.1s linear;
            -moz-transition: border 0.1s linear, box-shadow 0.1s linear;
            transition: border 0.1s linear, box-shadow 0.1s linear;
        }

        #myGlower.active {
            border-color: #DAA520;
            -webkit-box-shadow: 0 0 5px #DAA520;
            -moz-box-shadow: 0 0 5px #DAA520;
            box-shadow: 0 0 5px #DAA520;
        }

    </style>
</head>

<body style="margin-left:0px; margin-right:0px;">

    <div class="header">
        <h1>Visualizing RNNs</h1>
        <h2>Josh Varty</h2>
    </div>

    <section>
        Much has been said about the <a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">enreasonable
            effectiveness of recurrent neural networks</a>. One thing that always troubled me with RNNs was that I
        struggle to picture what's going on. I have a lot of trouble reconciling <strong>this:</strong>
    </section>

    <section>
        <script src="https://gist.github.com/JoshVarty/03e55e39c0fda828c08c6d8730c81368.js"></script>
    </section>

    <section>
        with <strong>this:</strong>
    </section>

    <section>
        <img width="500" src="https://i.imgur.com/Iveichs.jpg" />
    </section>

    <section>
        To help me understand exactly what's going on I want visualize every step of the forward pass. What do our
        inputs look like? What do our weights look like? How do things look at the beginning of training when compared
        to the end?
    </section>

    <section>
        In order to tackle this I quickly realized that we're going to have to use very small weight matrices or things
        will get out of hand very quickly. Even Andrej Karpathy's simple <a
            href="https://gist.github.com/karpathy/d4dee566867f8291f086">Min-Char RNN</a> has weight matrices with
        <strong>thousands</strong> of parameters. No matter how hard we try, we won't be able to put all those numbers
        on screen.
    </section>

    <section>
        Instead of predicting the next character in English text, let’s build a network that simply predicts the next
        output in the sequence
        <code>1</code>,<code>0</code>,<code>1</code>,<code>0</code>,<code>1</code>,<code>0</code>,<code>1</code>,<code>0</code>,<code>1</code>,<code>0</code>&nbsp;<code>...</code>&nbsp;This
        seems simple. Maybe even <strong>too</strong> simple, but that’s often the best way to approach something you
        don’t quite understand. A simple sequence like this will allow us to have tiny weight matrices, the largest of
        which will be <code>3x3</code>.
    </section>

    <section>
        For this project we’ll be using a <a
            href="https://github.com/JoshVarty/IntroToRNNs/blob/master/rnn.py">modified</a> version of Min-Char RNN.
        Since we’re preicting such a simple pattern we’ll use<span style="color:var(--color-neutral-600);">&nbsp;a
        </span><code>vocab_size</code><span style="color:var(--color-neutral-600);">&nbsp;of </span><code>2</code><span
            style="color:var(--color-neutral-600);">&nbsp;and a </span><code>hidden_size</code><span
            style="color:var(--color-neutral-600);">&nbsp;of </span><code>3</code><span
            style="color:var(--color-neutral-600);">.&nbsp;</span>
    </section>

    <section>
        Our program is fed an input of <code>1</code>,<code>0</code>,<code>1</code>,<code>0</code>&nbsp;and is tasked
        with predicting the target output sequence <code>0</code>,<code>1</code>,<code>0</code>,<code>1</code>, one
        character at a time. Since our network hasn’t been trained, observe that it output probabilities of roughly
        <code>0.50</code>&nbsp;at each time step.
    </section>

    <section>
        Click "Play" below.
    </section>

    <p>
        <pre>
<span id="line0"><span class='comment'>#Initialize weights and biases</span></span>
<span id="line1"><span class='input_weights_U'>input_weights_U</span> = np.random.randn(hidden_size, vocab_size) * 0.01</span>
<span id="line2"><span class='hidden_weights_W'>hidden_weights_W</span> = np.random.randn(hidden_size, hidden_size) * 0.01</span>
<span id="line3"><span class='hidden_bias'>hidden_bias</span> = np.zeros((hidden_size, 1)) # hidden bias</span>
<span id="line4"><span class='output_weights_V'>output_weights_V</span> = np.random.randn(vocab_size, hidden_size) * 0.01    # hidden to output</span>
<span id="line5"><span class='output_bias'>output_bias</span> = np.zeros((vocab_size, 1)) # output bias</span>
<span id="line6"><span class='comment'>#Forward pass</span></span>
<span id="line7">xs, hidden_states, outputs, probabilities = {}, {}, {}, {}</span>
<span id="line8"><span class='loss'>loss</span> = 0</span>
<span id="line9">hidden_states[-1] = np.copy(hidden_state_prev)</span>
<span id="line10"><span class="for">for</span> t <span class="in">in</span> range(len(inputs)): </span>
    <span id="line11"><span class="comment"># one-hot-encoding the input character</span> </span>
    <span id="line12"><span class='xs'>xs[t]</span> = np.zeros((vocab_size,1))  </span>
    <span id="line13"><span class='character'>character</span> = inputs[t]</span>
    <span id="line14"><span class='xs'>xs[t]</span>[character] = 1 </span>
    <span id="line15"><span class='target'>target</span> = targets[t]</span>
    <span id="line16"><span class="comment"># Compute hidden state </span></span>
    <span id="line17"><span class='hidden_state'>hidden_states[t]</span> = np.tanh(<span class='input_weights_U'>input_weights_U</span> @ <span class='xs'>xs[t]</span> + <span class='hidden_weights_W'>hidden_weights_W</span> @ <span class='hidden_state_prev'>hidden_states[t-1]</span> + <span class='hidden_bias'>hidden_bias</span>) </span>
    <span id="line18"><span class="comment"># Compute output and probabilities</span></span>
    <span id="line19"><span class='outputs'>outputs[t]</span> = <span class='output_weights_v'>output_weights_V</span> @ <span class="hidden_state">hidden_states[t]</span> + <span class='output_bias'>output_bias</span></span>
    <span id="line20"><span class='probabilities'>probabilities[t]</span> = np.exp(<span class='outputs'>outputs[t]</span>) / np.sum(np.exp(<span class='outputs'>outputs[t]</span>))</span>
    <span id="line21"><span class="comment">#Compute cross-entropy loss</span></span>
    <span id="line22"><span class='loss'>loss</span> += -np.log(<span class='probabilities'>probabilities[t]</span>[<span class='target'>target</span>,0]) </span></pre>
        <div class="controls-container">
            <button class="back" onclick="goBack()" title="Back"></button>
            <button id="myGlower" class="play" onclick="play()" title="Play"></button>
            <button class="stop" onclick="pause()" title="Stop"></button>
            <button class="forward" onclick="goFoward()" title="Next"></button>
        </div>
    </p>

    <br />

    <svg width=1500 height=600>
    </svg>


    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript">

        var glower = d3.select('#myGlower');

        var glowInterval = window.setInterval(function() {  
            glower.classed("active", !glower.classed("active"))
        }, 1000);

        let MAX_STATE_NUMBER = 44;
        var state = -1
        var runningInterval = null;

        function goBack() {
            clearInterval(runningInterval);
            state = Math.max(state - 1, 0);
            goState(state, false)
        }

        function goFoward() {
            if (runningInterval !== null) {
                clearInterval(runningInterval);
            }

            state = (state + 1) % MAX_STATE_NUMBER;
            goState(state, true)
        }

        function pause() {
            clearInterval(runningInterval);
        }

        function play() {
            clearInterval(glowInterval);
            glower.classed("active", false);
            clearInterval(runningInterval);

            runningInterval = setInterval(function () {
                state = (state + 1) % MAX_STATE_NUMBER;
                goState(state, true)
            }, 1000);
        }

        function goState0(doTransition) {
            let fadeIn = doTransition
            placeRNNBlock(50, 100, fadeIn)

            var U = [[0.04967142, 0.06476885, -0.02341534], [-0.01382643, 0.15230299, -0.0234137]]
            placeTensor("U", "U", 300, 370, U, fadeIn);
        }

        function goState1(doTransition) {
            goState0(false);
            let fadeIn = doTransition

            var W = [[0.15792128, 0.054256, 0.02419623],
            [0.07674347, -0.04634177, -0.19132802],
            [-0.04694744, -0.04657298, -0.17249178]]
            placeTensor("W", "W", 65, 195, W, fadeIn);
        }

        function goState2(doTransition) {
            goState1(false);
            let fadeIn = doTransition;

            var hidden_bias = [[0.00, 0.00, 0.00]]
            placeTensor("", "hidden_bias", 145, 130, hidden_bias, fadeIn);
        }

        function goState3(doTransition) {
            goState2(false);
            let fadeIn = doTransition;

            var output_weights = [[-0.05622875, -0.09080241],
            [-0.10128311, -0.14123037],
            [0.03142473, 0.14656488]]

            placeTensor_2Elements("V", "V", 300, 120, output_weights, fadeIn);
        }

        function goState4(doTransition) {
            goState3(false);
            let fadeIn = doTransition

            var output_bias = [[0, 0]]
            placeTensor_2Elements("", "output_bias", 440, 120, output_bias, fadeIn);
        }

        function goState5(doTransition) {
            goState4(false);
        }

        function goState6(doTransition) {
            goState5(false);
            let fadeIn = doTransition;

            placeText("loss", "loss", "0", 0, 20, fadeIn);
        }

        function goState7(doTransition) {
            goState6(false);
            let fadeIn = doTransition;

            var hidden_state_prev = [[0.0, 0.0, 0.0]]
            placeTensor("", "h", 0, 250, hidden_state_prev, fadeIn);
        }

        function goState8(doTransition) {
            goState7(false);
        }

        function goState9(doTransition) {
            goState8(false);
            let fadeIn = doTransition;

            let input_tensor = [[0.0, 0.0]];
            placeTensor_2Elements("x", "x", 238, 450, input_tensor, fadeIn);
        }

        function goState10(doTransition) {
            goState9(false);
            let fadeIn = doTransition;

            placeText("character", "character_0", "1", 260, 535, fadeIn);
        }

        function goState11(doTransition) {
            goState10(false);
            let fadeIn = false;
            let contentsChanged = doTransition;

            d3.select('#x').remove();
            let input_tensor = [[0.0, 1.0]];
            placeTensor_2Elements("x", "x", 238, 450, input_tensor, fadeIn, contentsChanged);
        }

        function goState12(doTransition) {
            goState11(false);
            let fadeIn = doTransition;

            placeText("target", "target_0", "0", 270, 15, fadeIn);
        }

        function goState13(doTransition) {
            goState12(false);
            let fadeIn = doTransition;
            let contentsChanged = false;

            let hidden_state = [[0.0496306, 0.06467844, -0.02341106]];
            placeTensor("", "hidden_state", 238, 240, hidden_state, fadeIn, contentsChanged);
        }

        function goState14(doTransition) {
            goState13(false);
            let fadeIn = doTransition;
            let contentsChanged = false;

            let outputs = [[-0.01007719, -0.01707238]];
            placeTensor_2Elements("o", "o", 190, 30, outputs, fadeIn, contentsChanged);
        }

        function goState15(doTransition) {
            goState14(false);
            let fadeIn = doTransition;
            let contentsChanged = false;

            let probabilities = [[0.50174879, 0.49825121]]
            placeTensor_2Elements("p", "p", 280, 30, probabilities, fadeIn, contentsChanged);
        }

        function goState16(doTransition) {
            goState15(false);
            let fadeIn = false;
            let contentsChanged = doTransition;

            d3.select('#loss').remove();
            placeText("loss", "loss", "0.69665", 0, 20, fadeIn, contentsChanged);
        }

        function goState17(doTransition) {
            goState16(false);
            let fadeIn = doTransition;
            let contentsChanged = false;

            placeRNNBlock(275, 100, fadeIn);

            d3.select("#o").remove();
            d3.select("#p").remove();
            d3.select("#x").remove();
            d3.select("#h").remove();
            d3.select('#hidden_state').attr('id', 'h');

            if (doTransition) {
                d3.select('#W').transition().attr('x', 320).attr('y', 155);
                d3.select('#V').transition().attr('x', 525).attr('y', 155);
                d3.select('#U').transition().attr('x', 525)
                d3.select('#hidden_bias').transition().attr('x', 400).attr('y', 90);
                d3.select('#output_bias').transition().attr('x', 665).attr('y', 155)
            }
            else {
                d3.select('#W').attr('x', 320).attr('y', 155);
                d3.select('#V').attr('x', 525).attr('y', 155);
                d3.select('#U').attr('x', 525)
                d3.select('#hidden_bias').attr('x', 400).attr('y', 90);
                d3.select('#output_bias').attr('x', 665).attr('y', 155)
            }
        }

        function goState18(doTransition) {
            goState17(false);
            let fadeIn = doTransition;
            let contentsChanged = false;

            let input_tensor = [[0.0, 0.0]];
            placeTensor_2Elements("x", "x", 460, 450, input_tensor, fadeIn);
        }

        function goState19(doTransition) {
            goState18(false);
            let fadeIn = doTransition;

            placeText("character", "character_1", "0", 480, 535, fadeIn);
        }

        function goState20(doTransition) {
            goState19(false);
            let fadeIn = false;
            let contentsChanged = doTransition;

            d3.select('#x').remove();
            let input_tensor = [[1.0, 0.0]];
            placeTensor_2Elements("x", "x", 460, 450, input_tensor, fadeIn, contentsChanged);
        }

        function goState21(doTransition) {
            goState20(false);
            let fadeIn = doTransition;

            placeText("target", "target_1", "1", 480, 15, fadeIn);
        }

        function goState22(doTransition) {
            goState21(false);

            let fadeIn = doTransition;
            let contentsChanged = false;

            let hidden_state = [[7.40357596e-05, 1.51903922e-01, -3.05399045e-02]]
            placeTensor("", "hidden_state", 460, 240, hidden_state, fadeIn, contentsChanged);
        }

        function goState23(doTransition) {
            goState22(false);

            let fadeIn = doTransition;
            let contentsChanged = false;

            let outputs = [[-0.01634917, -0.02593625]];
            placeTensor_2Elements("o", "o", 430, 20, outputs, fadeIn, contentsChanged);
        }

        function goState24(doTransition) {
            goState23(false);

            let fadeIn = doTransition;
            let contentsChanged = false;
            let probabilities = [[0.50239675, 0.49760325]]
            placeTensor_2Elements("p", "p", 520, 20, probabilities, fadeIn, contentsChanged);
        }

        function goState25(doTransition) {
            goState24(false);
            let fadeIn = false;
            let contentsChanged = doTransition;

            d3.select('#loss').remove();
            placeText("loss", "loss", "1.38501", 0, 20, fadeIn, contentsChanged);
        }

        function goState26(doTransition) {
            goState25(false);

            let fadeIn = doTransition;

            placeRNNBlock(500, 100, fadeIn);

            d3.select("#o").remove();
            d3.select("#p").remove();
            d3.select("#x").remove();
            d3.select("#h").remove();
            d3.select('#hidden_state').attr('id', 'h');

            if (doTransition) {
                d3.select('#W').transition().attr('x', 545)
                d3.select('#V').transition().attr('x', 750);
                d3.select('#U').transition().attr('x', 750);
                d3.select('#hidden_bias').transition().attr('x', 625)
                d3.select('#output_bias').transition().attr('x', 890);
            }
            else {
                d3.select('#W').attr('x', 545)
                d3.select('#V').attr('x', 750);
                d3.select('#U').attr('x', 750);
                d3.select('#hidden_bias').attr('x', 625)
                d3.select('#output_bias').attr('x', 890);
            }

        }

        function goState27(doTransition) {
            goState26(false);

            let fadeIn = doTransition;
            let contentsChanged = false;

            let input_tensor = [[0.0, 0.0]];
            placeTensor_2Elements("x", "x", 686, 450, input_tensor, fadeIn);
        }

        function goState28(doTransition) {
            goState27(false);

            let fadeIn = doTransition;
            placeText("character", "character_2", "1", 700, 535, fadeIn);
        }

        function goState29(doTransition) {
            goState28(false);
            let fadeIn = false;
            let contentsChanged = doTransition;

            d3.select('#x').remove();
            let input_tensor = [[0.0, 1.0]];
            placeTensor_2Elements("x", "x", 686, 450, input_tensor, fadeIn, contentsChanged);
        }

        function goState30(doTransition) {
            goState29(false);
            let fadeIn = doTransition;

            placeText("target", "target_2", "1", 700, 15, fadeIn);
        }

        function goState31(doTransition) {
            goState30(false);
            let fadeIn = doTransition;
            let contentsChanged = false;

            let hidden_state = [[0.06269218, 0.0590868, -0.0471741]]
            placeTensor("", "hidden_state", 686, 240, hidden_state, fadeIn, contentsChanged);
        }

        function goState32(doTransition) {
            goState31(false);

            let fadeIn = doTransition;
            let contentsChanged = false;

            let outputs = [[-0.01099203, -0.02095152]]
            placeTensor_2Elements("o", "o", 660, 20, outputs, fadeIn, contentsChanged);
        }

        function goState33(doTransition) {
            goState32(false);

            let fadeIn = doTransition;
            let contentsChanged = false;
            let probabilities = [[0.50248985, 0.49751015]];
            placeTensor_2Elements("p", "p", 750, 20, probabilities, fadeIn, contentsChanged);
        }

        function goState34(doTransition) {
            goState33(false);
            let fadeIn = false;
            let contentsChanged = doTransition;

            d3.select('#loss').remove();
            placeText("loss", "loss", "2.08315", 0, 20, fadeIn, contentsChanged);
        }

        function goState35(doTransition) {
            goState34(false);
            let fadeIn = doTransition;

            placeRNNBlock(725, 100, fadeIn);

            d3.select("#o").remove();
            d3.select("#p").remove();
            d3.select("#x").remove();
            d3.select("#h").remove();
            d3.select('#hidden_state').attr('id', 'h');

            if (doTransition) {
                d3.select('#W').transition().attr('x', 755)
                d3.select('#V').transition().attr('x', 975);
                d3.select('#U').transition().attr('x', 975);
                d3.select('#hidden_bias').transition().attr('x', 835)
                d3.select('#output_bias').transition().attr('x', 1115);
            }
            else {
                d3.select('#W').attr('x', 755)
                d3.select('#V').attr('x', 975);
                d3.select('#U').attr('x', 975);
                d3.select('#hidden_bias').attr('x', 835)
                d3.select('#output_bias').attr('x', 1115);
            }
        }

        function goState36(doTransition) {
            goState35(false);

            let fadeIn = doTransition;
            let input_tensor = [[0.0, 0.0]];
            placeTensor_2Elements("x", "x", 910, 450, input_tensor, fadeIn);
        }

        function goState37(doTransition) {
            goState36(false);

            let fadeIn = doTransition;
            placeText("character", "character_2", "0", 935, 535, fadeIn);
        }

        function goState38(doTransition) {
            goState37(false);
            let fadeIn = false;
            let contentsChanged = doTransition;

            d3.select('#x').remove();
            let input_tensor = [[1.0, 0.0]];
            placeTensor_2Elements("x", "x", 910, 450, input_tensor, fadeIn, contentsChanged);
        }

        function goState39(doTransition) {
            goState38(false);
            let fadeIn = doTransition;
            let contentsChanged = false;

            placeText("target", "target_3", "0", 933, 15, fadeIn);
        }

        function goState40(doTransition) {
            goState39(false);

            let fadeIn = doTransition;
            let contentsChanged = false;

            let hidden_state = [[0.00282322, 0.15392992, -0.02505935]]
            placeTensor("", "hidden_state", 910, 240, hidden_state, fadeIn, contentsChanged);
        }

        function goState41(doTransition) {
            goState40(false);

            let fadeIn = doTransition;
            let contentsChanged = false;
            let outputs = [[-0.01102358, -0.02113569]]
            placeTensor_2Elements("o", "o", 880, 20, outputs, fadeIn, contentsChanged);
        }

        function goState42(doTransition) {
            goState41(false);
            let fadeIn = doTransition;
            let contentsChanged = false;

            let probabilities = [[0.502528, 0.497472]]
            placeTensor_2Elements("p", "p", 970, 20, probabilities, fadeIn, contentsChanged);
        }

        function goState43(doTransition) {
            goState42(false);

            let fadeIn = false;
            let contentsChanged = doTransition;

            d3.select('#loss').remove();
            placeText("loss", "loss", "2.77402", 0, 20, fadeIn, contentsChanged);
        }

        function goState(state, doTransition) {
            //Clear the svg and but our arrowhead definitions
            d3.select("svg").selectAll("*").remove()
            d3.select("svg").append("defs")
                .append("marker")
                .attr("id", "arrow")
                .attr("markerWidth", 10)
                .attr("markerHeight", 10)
                .attr("refX", 0)
                .attr("refY", 3)
                .attr("orient", "auto")
                .append('path')
                .attr('d', 'M0,0 L0,6 L9,3 z')
                .attr('fill', '#000')

            //Clear active line
            var activeLines = document.getElementsByClassName("active-line");
            for (var i = 0; i < activeLines.length; i++) {
                var currentActiveLine = activeLines[i];
                currentActiveLine.classList.remove('active-line')
            }

            if (state == 0) {
                var activeLine = document.getElementById("line1")
                activeLine.setAttribute('class', 'active-line')
                goState0(doTransition)
            }
            else if (state == 1) {
                var activeLine = document.getElementById("line2")
                activeLine.setAttribute('class', 'active-line')
                goState1(doTransition);
            }
            else if (state == 2) {
                var activeLine = document.getElementById("line3")
                activeLine.setAttribute('class', 'active-line')
                goState2(doTransition);
            }
            else if (state == 3) {
                var activeLine = document.getElementById("line4")
                activeLine.setAttribute('class', 'active-line')
                goState3(doTransition);
            }
            else if (state == 4) {
                var activeLine = document.getElementById("line5")
                activeLine.setAttribute('class', 'active-line')
                goState4(doTransition);
            }
            else if (state == 5) {
                var activeLine = document.getElementById("line7")
                activeLine.setAttribute('class', 'active-line')
                goState5(doTransition);
            }
            else if (state == 6) {
                var activeLine = document.getElementById("line8")
                activeLine.setAttribute('class', 'active-line')
                goState6(doTransition);
            }
            else if (state == 7) {
                var activeLine = document.getElementById("line9")
                activeLine.setAttribute('class', 'active-line')
                goState7(doTransition);
            }
            else if (state == 8) {
                var activeLine = document.getElementById("line10")
                activeLine.setAttribute('class', 'active-line')
                goState8(doTransition);
            }
            else if (state == 9) {
                var activeLine = document.getElementById("line12")
                activeLine.setAttribute('class', 'active-line')
                goState9(doTransition);
            }
            else if (state == 10) {
                var activeLine = document.getElementById("line13")
                activeLine.setAttribute('class', 'active-line')
                goState10(doTransition);
            }
            else if (state == 11) {
                var activeLine = document.getElementById("line14")
                activeLine.setAttribute('class', 'active-line')
                goState11(doTransition);
            }
            else if (state == 12) {
                var activeLine = document.getElementById("line15")
                activeLine.setAttribute('class', 'active-line')
                goState12(doTransition);
            }
            else if (state == 13) {
                var activeLine = document.getElementById("line17")
                activeLine.setAttribute('class', 'active-line')
                goState13(doTransition);
            }
            else if (state == 14) {
                var activeLine = document.getElementById("line19")
                activeLine.setAttribute('class', 'active-line')
                goState14(doTransition);
            }
            else if (state == 15) {
                var activeLine = document.getElementById("line20")
                activeLine.setAttribute('class', 'active-line')
                goState15(doTransition);
            }
            else if (state == 16) {
                var activeLine = document.getElementById("line22")
                activeLine.setAttribute('class', 'active-line')
                goState16(doTransition);
            }
            else if (state == 17) {
                var activeLine = document.getElementById("line10")
                activeLine.setAttribute('class', 'active-line')
                goState17(doTransition);
            }
            else if (state == 18) {
                var activeLine = document.getElementById("line12")
                activeLine.setAttribute('class', 'active-line')
                goState18(doTransition);
            }
            else if (state == 19) {
                var activeLine = document.getElementById("line13")
                activeLine.setAttribute('class', 'active-line')
                goState19(doTransition);
            }
            else if (state == 20) {
                var activeLine = document.getElementById("line14")
                activeLine.setAttribute('class', 'active-line')
                goState20(doTransition);
            }
            else if (state == 21) {
                var activeLine = document.getElementById("line15")
                activeLine.setAttribute('class', 'active-line')
                goState21(doTransition);
            }
            else if (state == 22) {
                var activeLine = document.getElementById("line17")
                activeLine.setAttribute('class', 'active-line')
                goState22(doTransition);
            }
            else if (state == 23) {
                var activeLine = document.getElementById("line19")
                activeLine.setAttribute('class', 'active-line')
                goState23(doTransition);
            }
            else if (state == 24) {
                var activeLine = document.getElementById("line20")
                activeLine.setAttribute('class', 'active-line')
                goState24(doTransition);
            }
            else if (state == 25) {
                var activeLine = document.getElementById("line22")
                activeLine.setAttribute('class', 'active-line')
                goState25(doTransition);
            }
            else if (state == 26) {
                var activeLine = document.getElementById("line10")
                activeLine.setAttribute('class', 'active-line')
                goState26(doTransition);
            }
            else if (state == 27) {
                var activeLine = document.getElementById("line12")
                activeLine.setAttribute('class', 'active-line')
                goState27(doTransition);
            }
            else if (state == 28) {
                var activeLine = document.getElementById("line13")
                activeLine.setAttribute('class', 'active-line')
                goState28(doTransition);
            }
            else if (state == 29) {
                var activeLine = document.getElementById("line14")
                activeLine.setAttribute('class', 'active-line')
                goState29(doTransition);
            }
            else if (state == 30) {
                var activeLine = document.getElementById("line15")
                activeLine.setAttribute('class', 'active-line')
                goState30(doTransition);
            }
            else if (state == 31) {
                var activeLine = document.getElementById("line17")
                activeLine.setAttribute('class', 'active-line')
                goState31(doTransition);
            }
            else if (state == 32) {
                var activeLine = document.getElementById("line19")
                activeLine.setAttribute('class', 'active-line')
                goState32(doTransition);
            }
            else if (state == 33) {
                var activeLine = document.getElementById("line20");
                activeLine.setAttribute('class', 'active-line');
                goState33(doTransition);
            }
            else if (state == 34) {
                var activeLine = document.getElementById("line22");
                activeLine.setAttribute('class', 'active-line');
                goState34(doTransition);
            }
            else if (state == 35) {
                var activeLine = document.getElementById("line10");
                activeLine.setAttribute('class', 'active-line');
                goState35(doTransition);
            }
            else if (state == 36) {
                var activeLine = document.getElementById("line12");
                activeLine.setAttribute('class', 'active-line');
                goState36(doTransition);
            }
            else if (state == 37) {
                var activeLine = document.getElementById("line13");
                activeLine.setAttribute('class', 'active-line');
                goState37(doTransition);
            }
            else if (state == 38) {
                var activeLine = document.getElementById("line14");
                activeLine.setAttribute('class', 'active-line');
                goState38(doTransition);
            }
            else if (state == 39) {
                var activeLine = document.getElementById("line15");
                activeLine.setAttribute('class', 'active-line');
                goState39(doTransition);
            }
            else if (state == 40) {
                var activeLine = document.getElementById("line17");
                activeLine.setAttribute('class', 'active-line');
                goState40(doTransition);
            }
            else if (state == 41) {
                var activeLine = document.getElementById("line19");
                activeLine.setAttribute('class', 'active-line');
                goState41(doTransition);
            }
            else if (state == 42) {
                var activeLine = document.getElementById("line20");
                activeLine.setAttribute('class', 'active-line');
                goState42(doTransition);
            }
            else if (state == 43) {
                var activeLine = document.getElementById("line22");
                activeLine.setAttribute('class', 'active-line');
                goState43(doTransition);
            }

            function hoverElement(selectId, selectClass) {
                d3.selectAll(selectClass)
                    .attr('style', 'background:red;');

                var offset = 5;
                d3.select(selectId + " g")
                    .transition()
                    .attr('style', 'fill:red;')
                    .attr('transform', 'scale(1.05) translate(-' + offset + ')')
                    .duration(100)
                    .transition()
                    .attr('transform', 'scale(1)')
                    .duration(100)

            }

            function leaveElement(selectId, selectClass) {
                d3.selectAll(selectClass)
                    .attr('style', '');
                d3.select(selectId + " g")
                    .transition()
                    .attr('style', '')
                    .attr('transform', '')
            }

            function setupHoverHandlers(selectId, selectClass) {
                //When hovering over the element on the diagram
                d3.select(selectId)
                    .on('mouseover', function () {
                        hoverElement(selectId, selectClass);
                    })
                    .on('mouseleave', function () {
                        leaveElement(selectId, selectClass);
                    });

                //When hovering over the element in code
                d3.selectAll(selectClass)
                    .on('mouseover', function () {
                        hoverElement(selectId, selectClass);
                    })
                    .on('mouseleave', function () {
                        leaveElement(selectId, selectClass);
                    });
            }

            //Set up hover event listeners
            setupHoverHandlers("#U", ".input_weights_U");
            setupHoverHandlers("#W", ".hidden_weights_W");
            setupHoverHandlers("#hidden_bias", ".hidden_bias");
            setupHoverHandlers("#V", ".output_weights_V");
            setupHoverHandlers("#output_bias", '.output_bias');
            setupHoverHandlers("#x", ".xs");
            setupHoverHandlers("#hidden_state", ".hidden_state");
            setupHoverHandlers("#h", ".hidden_state_prev");
            setupHoverHandlers("#o", ".outputs");
            setupHoverHandlers("#p", ".probabilities");
        }

        function placeText(name, id, value, xOffset, yOffset, fadeIn, contentsChanged) {
            //TODO: Make it look better (font and size)
            var container = d3.select("svg").append("svg")
                .attr('id', id);
            var label = container.append("text")
                .text(name)
                .attr('x', xOffset)
                .attr('y', yOffset);

            //We have to account for the number of characters in our "name" label
            let numberOfCharactersInName = name.length;
            let nameOffset = numberOfCharactersInName * 7;

            var equals = container.append("text")
                .text('=')
                .attr('x', xOffset + nameOffset)
                .attr('y', yOffset);

            var value = container.append("text")
                .text(value)
                .attr('x', xOffset + nameOffset + 12)
                .attr('y', yOffset);

            if (fadeIn) {
                for (let item of [label, equals, value]) {
                    item.attr('opacity', 0)
                        .transition()
                        .attr('opacity', 1)
                }
            }

            if (contentsChanged === true) {
                for (let item of [value]) {
                    item.style('fill', 'red')
                }
            }

        }

        function placeRNNBlock(xOffset, yOffset, fadeIn) {
            //Create diagram container
            var diagramContainer = d3.select("svg").append("svg");
            //Draw first hidden-state square
            var rect = diagramContainer.append("rect")
                .attr("x", xOffset + 200)
                .attr("y", yOffset + 125)
                .attr("style", "fill:rgb(255,255,255);stroke-width:3;stroke:rgb(0,0,0)")
                .attr("width", 100).attr("height", 0)
                .attr("height", 100)

            //bottom arrow
            var line = diagramContainer.append("line")
                .attr("x1", xOffset + 250)
                .attr("y1", yOffset + 350)
                .attr("x2", xOffset + 250)
                .attr("y2", yOffset + 250)
                .attr("stroke", "black")
                .attr("stroke-width", "3")
                .attr("marker-end", "url(#arrow)")

            //left arrow
            var leftArrow = diagramContainer.append("line")
                .attr("x1", xOffset + 75)
                .attr("y1", yOffset + 175)
                .attr("x2", xOffset + 175)
                .attr("y2", yOffset + 175)
                .attr("stroke", "black")
                .attr("stroke-width", "3")
                .attr("marker-end", "url(#arrow)")

            //top arrow
            var topArrow = diagramContainer.append("line")
                .attr("x1", xOffset + 250)
                .attr("y1", yOffset + 125)
                .attr("x2", xOffset + 250)
                .attr("y2", yOffset + 40)
                .attr("stroke", "black")
                .attr("stroke-width", "3")
                .attr("marker-end", "url(#arrow)")

            if (fadeIn) {
                for (let item of [rect, line, leftArrow, topArrow]) {
                    item.attr('opacity', 0)
                        .transition()
                        .attr('opacity', 1)
                }
            }
        }

        function placeTensor(name, id, xOffset, yOffset, tensorElements, fadeIn, contentsChanged) {

            var container = d3.select("svg").append('svg')
                .attr('x', xOffset)
                .attr('y', yOffset)
                .attr('id', id)
                .append('g')

            var numberOfColumns = tensorElements.length;
            var numberOfRows = tensorElements[0].length;

            var text = container.append('text')
                .attr('x', 10)
                .attr('y', 45)
                .attr('class', 'array-name')
                .text(name)

            var lb = container.append('text')
                .attr('x', 30)
                .attr('y', 52)
                .attr('class', 'array-bracket')
                .text('[')

            var rb = container.append('text')
                .attr('x', (numberOfColumns * 40) + 40)
                .attr('y', 52)
                .attr('class', 'array-bracket')
                .text(']')

            var elements = container.selectAll('svg').data(tensorElements).enter().append("svg")
                .attr("class", 'array')
                .attr("x", function (d, i, j) { return (i * 40) + 50; })
                .selectAll('text')
                .data(function (d, i, j) { return d; }).enter().append('text')
                .text(function (d, i, j) { return d.toFixed(2); })
                .attr("y", function (d, i, j) {
                    return (i * 20) + 20;
                })

            var rect = container.append('rect')
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', ((numberOfColumns * 40) + 50))
                .attr('height', (numberOfRows * 20))
                .attr('fill', 'transparent')

            if (fadeIn === true) {
                var offset = 5;
                if (numberOfColumns == 1) {
                    offset = 3;
                }

                container
                    .attr('transform', 'scale(0.95) translate(' + offset + ')')
                    .attr('opacity', 0)
                    .transition().attr('transform', 'scale(1.05) translate(-' + offset + ')').attr('opacity', '1')
                    .transition().attr('transform', 'scale(1)')
            }

            if (contentsChanged === true) {
                for (let item of [elements]) {
                    item.style('fill', 'red')
                }
            }
        }

        function placeTensor_2Elements(name, id, xOffset, yOffset, tensorElements, fadeIn, contentsChanged) {

            var container = d3.select("svg").append('svg')
                .attr('x', xOffset)
                .attr('y', yOffset)
                .attr('id', id)
                .append('g')

            var numberOfColumns = tensorElements.length;
            var numberOfRows = 2;

            var text = container.append('text')
                .attr('x', 10)
                .attr('y', 45)
                .attr('class', 'array-name')
                .text(name)

            var lb = container.append('text')
                .attr('x', 30)
                .attr('y', 52)
                .attr('class', 'array-bracket')
                .text('[')

            var rb = container.append('text')
                .attr('x', (numberOfColumns * 40) + 40)
                .attr('y', 52)
                .attr('class', 'array-bracket')
                .text(']')

            var elements = container.selectAll('svg').data(tensorElements).enter().append("svg")
                .attr("class", 'array')
                .attr("x", function (d, i, j) { return (i * 40) + 50; })
                .selectAll('text')
                .data(function (d, i, j) { return d; }).enter().append('text')
                .text(function (d, i, j) { return d.toFixed(2); })
                .attr("y", function (d, i, j) {
                    return (i * 20) + 30;
                })

            var rect = container.append('rect')
                .attr('x', 23)
                .attr('y', 0)
                .attr('width', (numberOfColumns * 40) + 30)
                .attr('height', (numberOfRows * 20) + 30)
                .attr('fill', 'transparent')

            if (fadeIn === true) {
                var offset = 5;
                if (numberOfColumns == 1) {
                    offset = 3;
                }

                container
                    .attr('transform', 'scale(0.95) translate(' + offset + ')')
                    .attr('opacity', 0)
                    .transition().attr('transform', 'scale(1.05) translate(-' + offset + ')').attr('opacity', '1')
                    .transition().attr('transform', 'scale(1)')
            }

            if (contentsChanged === true) {
                for (let item of [elements]) {
                    item.style('fill', 'red')
                }
            }
        }

    </script>
</body>

</html>