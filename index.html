<html>

<head>
    <style>
        pre {
            background: #1e1e1e;
            padding: 15px;
            color: #dfdfdf;
        }

        .comment {
            color: #688e49;
        }

        .for {
            color: #b680ba;
        }

        .in {
            color: #5b94cf;
        }

        .array {
            color: black;
            font: bold;
        }

        .array-bracket {
            color: black;
            font-family: sans-serif;
            font-size: 4em;
        }

        .array-name {
            color: black;
            font-family: sans-serif;
            font-size: 1.5em;
        }

        .active-line {
            background: #8e8f32;
            color: #ddd;
        }
    </style>
</head>

<body>


    <p>test</p>
    <p>
        <pre>
<span id="line0"><span class='comment'>#Initialize weights and biases</span></span>
<span id="line1">input_weights_U = np.random.randn(hidden_size, vocab_size) * 0.01</span>
<span id="line2">hidden_weights_W = np.random.randn(hidden_size, hidden_size) * 0.01</span>
<span id="line3">hidden_bias = np.zeros((hidden_size, 1)) # hidden bias</span>
<span id="line4">output_weights_V = np.random.randn(vocab_size, hidden_size) * 0.01    # hidden to output</span>
<span id="line5">output_bias = np.zeros((vocab_size, 1)) # output bias</span>
<span id="line6"><span class='comment'>#Forward pass</span></span>
<span id="line7">xs, hidden_states, outputs, probabilities = {}, {}, {}, {}</span>
<span id="line8">loss = 0</span>
<span id="line9">hidden_states[-1] = np.copy(hidden_state_prev)</span>
<span id="line10"><span class="for">for</span> t <span class="in">in</span> range(len(inputs)): </span>
    <span id="line11"><span class="comment"># one-hot-encoding the input character</span> </span>
    <span id="line12">xs[t] = np.zeros((vocab_size,1))  </span>
    <span id="line13">character = inputs[t]</span>
    <span id="line14">xs[t][character] = 1 </span>
    <span id="line15"><span class="comment"># Compute hidden state </span></span>
    <span id="line16">hidden_states[t] = np.tanh(input_weights_U @ xs[t] + hidden_weights_W @ hidden_states[t-1] + hidden_bias) </span>
    <span id="line17"><span class="comment"># Compute output and probabilities</span></span>
    <span id="line18">outputs[t] = output_weights_V @ hidden_states[t] + output_bias</span>
    <span id="line19">probabilities[t] = np.exp(outputs[t]) / np.sum(np.exp(outputs[t]))</span>
    <span id="line20"><span class="comment">#Compute cross-entropy loss</span></span>
    <span id="line21">loss += -np.log(probabilities[t][targets[t],0]) </span>
       </pre>
    </p>

    <button onclick="goBack()">Back</button>
    <button onclick="goFoward()">Forward</button>
    <br />

    <svg width=900 height=500>
    </svg>


    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript">

        var state = -1
        function goBack() {
            state = state - 1;
            goState(state, false)
        }

        function goFoward() {
            state = state + 1;
            goState(state, true)
        }

        function goState0(doTransition) {

            transition_dict = {}
            if (doTransition) {
                transition_dict['startOpacity'] = 0
                transition_dict['endOpacity'] = 1
            }

            placeRNNBlock(50, 50, transition_dict)

            var U = [[0.01, 0.02, 0.03], [0.04, 0.03, 0.05]]
            placeTensor("U", 150, 155, U, transition_dict);
        }

        function goState1(doTransition) {

            goState0(false);

            transition_dict = {}
            if (doTransition) {
                transition_dict['startOpacity'] = 0
                transition_dict['endOpacity'] = 1
            }

            var W = [[0.01579213, 0.00767435, -0.00469474],
            [0.0054256, -0.00463418, -0.0046573],
            [0.00241962, -0.0191328, -0.01724918]]
            placeTensor("W", 30, 70, W, transition_dict);
        }

        function goState2() {

            goState1(false)

            transition_dict = {}

            var hidden_bias = [[0.00, 0.00, 0.00]]
            placeTensor("", 30, 30, hidden_bias);
        }

        function goState3() {

            goState2(false)

            var output_weights = [[-0.00562288, -0.01012831, 0.00314247],
            [-0.00908024, -0.01412304, 0.01465649]]
            placeTensor("V", 160, 30, output_weights);
        }

        function goState4() {
            goState3(false)

            var output_bias = [[0, 0]]
            placeTensor_2Elements("", 215, 30, output_bias);
        }

        function goState5() {
            goState4(false)
        }

        function goState6() {
            goState5(false)
            placeText("loss", "0", 0, 20);
        }

        function goState7() {
            goState6(false)

            var hidden_state_prev = [[0.0, 0.0, 0.0]]
            placeTensor("h", 0, 105, hidden_state_prev);
        }

        function goState8() {
            goState7(false)
        }

        function goState(state, doTransition) {
            //Clear the svg and but our arrowhead definitions
            d3.select("svg").selectAll("*").remove()
            d3.select("svg").append("defs")
                .append("marker")
                .attr("id", "arrow")
                .attr("markerWidth", 10)
                .attr("markerHeight", 10)
                .attr("refX", 0)
                .attr("refY", 3)
                .attr("orient", "auto")
                .append('path')
                .attr('d', 'M0,0 L0,6 L9,3 z')
                .attr('fill', '#000')

            //Clear active line
            var activeLines = document.getElementsByClassName("active-line");
            for (var i = 0; i < activeLines.length; i++) {
                var currentActiveLine = activeLines[i];
                currentActiveLine.classList.remove('active-line')
            }

            if (state == 0) {
                var activeLine = document.getElementById("line1")
                activeLine.setAttribute('class', 'active-line')
                return goState0(doTransition)
            }
            else if (state == 1) {
                var activeLine = document.getElementById("line2")
                activeLine.setAttribute('class', 'active-line')
                return goState1(doTransition);
            }
            else if (state == 2) {
                var activeLine = document.getElementById("line3")
                activeLine.setAttribute('class', 'active-line')
                return goState2(doTransition);
            }
            else if (state == 3) {
                var activeLine = document.getElementById("line4")
                activeLine.setAttribute('class', 'active-line')
                return goState3(doTransition);
            }
            else if (state == 4) {
                var activeLine = document.getElementById("line5")
                activeLine.setAttribute('class', 'active-line')
                return goState4(doTransition);
            }
            else if (state == 5) {
                var activeLine = document.getElementById("line7")
                activeLine.setAttribute('class', 'active-line')
                return goState5(doTransition);
            }
            else if (state == 6) {
                var activeLine = document.getElementById("line8")
                activeLine.setAttribute('class', 'active-line')
                return goState6(doTransition);
            }
            else if (state == 7) {
                var activeLine = document.getElementById("line9")
                activeLine.setAttribute('class', 'active-line')
                return goState7(doTransition);
            }
            else if (state == 8) {
                var activeLine = document.getElementById("line10")
                activeLine.setAttribute('class', 'active-line')
                return goState8(doTransition);
            }
            else if (state == 9) {
                return goState9(doTransition);
            }
            else if (state == 10) {

                return goState10(doTransition); 
            }
        }

        function placeText(name, value, xOffset, yOffset) {
            //TODO: Make it look better (font and size)
            var container = d3.select("svg").append("svg");
            container.append("text")
                .text(name)
                .attr('x', xOffset)
                .attr('y', yOffset);

            container.append("text")
                .text('=')
                .attr('x', xOffset + 27)
                .attr('y', yOffset);

            container.append("text")
                .text(value)
                .attr('x', xOffset + 40)
                .attr('y', yOffset);
        }

        function placeRNNBlock(xOffset, yOffset, transition_dict) {
            //Create diagram container
            var diagramContainer = d3.select("svg").append("svg");
            //Draw first hidden-state square
            var rect = diagramContainer.append("rect")
                .attr("x", xOffset + 200)
                .attr("y", yOffset + 125)
                .attr("style", "fill:rgb(255,255,255);stroke-width:3;stroke:rgb(0,0,0)")
                .attr("width", 100).attr("height", 0)
                .attr("height", 100)


            //bottom arrow
            var line = diagramContainer.append("line")
                .attr("x1", xOffset + 250)
                .attr("y1", yOffset + 350)
                .attr("x2", xOffset + 250)
                .attr("y2", yOffset + 250)
                .attr("stroke", "black")
                .attr("stroke-width", "3")
                .attr("marker-end", "url(#arrow)")

            //left arrow
            var leftArrow = diagramContainer.append("line")
                .attr("x1", xOffset + 75)
                .attr("y1", yOffset + 175)
                .attr("x2", xOffset + 175)
                .attr("y2", yOffset + 175)
                .attr("stroke", "black")
                .attr("stroke-width", "3")
                .attr("marker-end", "url(#arrow)")

            //top arrow
            var topArrow = diagramContainer.append("line")
                .attr("x1", xOffset + 250)
                .attr("y1", yOffset + 125)
                .attr("x2", xOffset + 250)
                .attr("y2", yOffset + 40)
                .attr("stroke", "black")
                .attr("stroke-width", "3")
                .attr("marker-end", "url(#arrow)")
            
            if (transition_dict && transition_dict.startOpacity !== undefined) {
                for (let item of [rect, line, leftArrow, topArrow]) {
                    item.attr('opacity', transition_dict['startOpacity'])
                    .transition()
                    .attr('opacity', transition_dict['endOpacity'])
                }
            }
        }


        function placeTensor(name, xOffset, yOffset, tensorElements, transition_dict) {

            var container = d3.select("svg").append('svg')
                .attr('x', xOffset)
                .attr('y', yOffset)

            var text = container.append('text')
                .attr('x', xOffset + 10)
                .attr('y', yOffset + 45)
                .attr('class', 'array-name')
                .text(name)

            var lb = container.append('text')
                .attr('x', xOffset + 30)
                .attr('y', yOffset + 52)
                .attr('class', 'array-bracket')
                .text('[')

            var numberOfColumns = tensorElements.length;
            var rb = container.append('text')
                .attr('x', xOffset + (numberOfColumns * 40) + 40)
                .attr('y', yOffset + 52)
                .attr('class', 'array-bracket')
                .text(']')

            var elements = container.selectAll('svg').data(tensorElements).enter().append("svg")
                .attr("class", 'array')
                .attr("x", function (d, i, j) { return (i * 40) + 50 + xOffset; })
                .selectAll('text')
                .data(function (d, i, j) { return d; }).enter().append('text')
                .text(function (d, i, j) { return d.toFixed(2); })
                .attr("y", function (d, i, j) {
                    return (i * 20) + 20 + yOffset;
                })

            if (transition_dict && transition_dict.startOpacity !== undefined) {
                for (let item of [text, lb, rb, elements]) {
                    item.attr('opacity', transition_dict['startOpacity'])
                    .transition()
                    .attr('opacity', transition_dict['endOpacity'])
                }
            }
        }


        function placeTensor_2Elements(name, xOffset, yOffset, tensorElements) {

            var container = d3.select("svg").append('svg')
                .attr('x', xOffset)
                .attr('y', yOffset)

            container.append('text')
                .attr('x', xOffset + 10)
                .attr('y', yOffset + 45)
                .attr('class', 'array-name')
                .text(name)

            container.append('text')
                .attr('x', xOffset + 30)
                .attr('y', yOffset + 52)
                .attr('class', 'array-bracket')
                .text('[')

            var numberOfColumns = tensorElements.length;
            container.append('text')
                .attr('x', xOffset + (numberOfColumns * 40) + 40)
                .attr('y', yOffset + 52)
                .attr('class', 'array-bracket')
                .text(']')

            container.selectAll('svg').data(tensorElements).enter().append("svg")
                .attr("class", 'array')
                .attr("x", function (d, i, j) { return (i * 40) + 50 + xOffset; })
                .selectAll('text')
                .data(function (d, i, j) { return d; }).enter().append('text')
                .text(function (d, i, j) { return d.toFixed(2); })
                .attr("y", function (d, i, j) {
                    return (i * 20) + 30 + yOffset;
                })
        }

    //Draw U array
    //placeRNNBlock(50,0)

    // var U = [[0.01, 0.02, 0.03], [0.04, 0.03, 0.05]]
    // placeTensor("U", 150, 135, U);

    // var W = [[ 0.01579213,  0.00767435, -0.00469474],
    //    [ 0.0054256 , -0.00463418, -0.0046573 ],
    //    [ 0.00241962, -0.0191328 , -0.01724918]]
    // placeTensor("W", 30, 30, W);

    // var hidden_state = [[0.00, 0.00, 0.00]]
    // placeTensor("h", 0, 70, hidden_state);

    // var x = [[0, 0]]
    // placeTensor_2Elements("x", 115, 175, x);

    </script>
</body>

</html>